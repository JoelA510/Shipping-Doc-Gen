
> @formwaypoint/api@0.1.0 test
> jest

PASS src/services/compliance/complianceService.test.js
PASS tests/ocr_mapper.test.js
PASS tests/csv_unit.test.js
PASS tests/party_service.test.js
PASS tests/item_service.test.js
PASS tests/view_models.test.js
FAIL tests/portability.test.js
  ΓùÅ Test suite failed to run

    Cannot find module '../src/lib/prisma' from 'tests/portability.test.js'

      3 |
      4 | // Mock Prisma - defined inline to avoid hoisting issues
    > 5 | jest.mock('../src/lib/prisma', () => {
        |      ^
      6 |     const mockClient = {
      7 |         shipment: {
      8 |             findUnique: jest.fn(),

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.mock (tests/portability.test.js:5:6)

FAIL tests/validation.test.js
  ΓùÅ Validation Engine ΓÇ║ should pass valid shipment

    expect(received).toHaveLength(expected)

    Expected length: 0
    Received length: 2
    Received array:  [{"code": "VAL-001", "message": "Incoterm is required", "path": "incoterm", "severity": "error"}, {"code": "VAL-101", "message": "HTS Code '1234.56' not found in reference database", "path": "lineItems[0].htsCode", "severity": "warning"}]

      17 |     it('should pass valid shipment', async () => {
      18 |         const result = await validateShipment(validShipment, validLines);
    > 19 |         expect(result.issues).toHaveLength(0);
         |                               ^
      20 |     });
      21 |
      22 |     it('should detect missing parties (R1)', async () => {

      at Object.toHaveLength (tests/validation.test.js:19:31)

PASS tests/auth.test.js
PASS tests/generator.test.js (5.703 s)
  ΓùÅ Console

    console.log
      [Generator] Loading template: C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\src\templates\sli.hbs

      at log (src/services/generator.js:17:17)

    console.log
      [Generator] Rendering template with context

      at log (src/services/generator.js:33:17)

    console.log
      [Generator] Template rendered successfully, launching browser

      at log (src/services/generator.js:35:17)

    console.log
      [Generator] Setting page content

      at log (src/services/generator.js:44:21)

    console.log
      [Generator] Generating PDF

      at log (src/services/generator.js:46:21)

    console.log
      [Generator] PDF generated successfully

      at log (src/services/generator.js:61:21)

PASS tests/history_comments.test.js (6.163 s)
FAIL tests/parties_shipments.test.js (6.372 s)
  ΓùÅ Console

    console.error
      List parties error: TypeError: prisma.party.count is not a function
          at Object.count [as listParties] (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\src\services\parties\partyService.js:29:26)
          at listParties (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\src\routes\parties.js:12:43)
          at Layer.handle [as handle_request] (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\layer.js:95:5)
          at next (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\route.js:149:13)
          at Route.dispatch (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\route.js:119:3)
          at Layer.handle [as handle_request] (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\layer.js:95:5)
          at C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:284:15
          at router.process_params (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:346:12)
          at next (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:280:10)
          at router.handle (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:175:3)
          at router (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:47:12)
          at Layer.handle [as handle_request] (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\layer.js:95:5)
          at trim_prefix (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:328:13)
          at C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:286:9
          at router.process_params (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:346:12)
          at next (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:280:10)
          at next (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\src\middleware\auth.js:23:9)
          at Layer.handle [as handle_request] (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\layer.js:95:5)
          at trim_prefix (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:328:13)
          at C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:286:9
          at router.process_params (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:346:12)
          at next (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:280:10)
          at jsonParser (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\body-parser\lib\types\json.js:113:7)
          at Layer.handle [as handle_request] (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\layer.js:95:5)
          at trim_prefix (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:328:13)
          at C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:286:9
          at router.process_params (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:346:12)
          at next (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:280:10)
          at cors (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\cors\lib\index.js:188:7)
          at C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\cors\lib\index.js:224:17
          at originCallback (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\cors\lib\index.js:214:15)
          at C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\cors\lib\index.js:219:13
          at optionsCallback (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\cors\lib\index.js:199:9)
          at corsMiddleware (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\cors\lib\index.js:204:7)
          at Layer.handle [as handle_request] (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\layer.js:95:5)
          at trim_prefix (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:328:13)
          at C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:286:9
          at router.process_params (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:346:12)
          at next (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:280:10)
          at internalNext (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:537:6)
          at xXssProtectionMiddleware (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:315:3)
          at internalNext (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:535:6)
          at xPoweredByMiddleware (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:308:3)
          at internalNext (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:535:6)
          at xPermittedCrossDomainPoliciesMiddleware (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:301:3)
          at internalNext (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:535:6)
          at xFrameOptionsMiddleware (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:285:3)
          at internalNext (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:535:6)
          at xDownloadOptionsMiddleware (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:265:3)
          at internalNext (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:535:6)
          at xDnsPrefetchControlMiddleware (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:258:3)
          at internalNext (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:535:6)
          at xContentTypeOptionsMiddleware (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:250:3)
          at internalNext (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:535:6)
          at strictTransportSecurityMiddleware (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:243:3)
          at internalNext (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:535:6)
          at referrerPolicyMiddleware (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:211:3)
          at internalNext (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:535:6)
          at originAgentClusterMiddleware (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:186:3)
          at internalNext (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:535:6)
          at crossOriginResourcePolicyMiddleware (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:179:3)
          at internalNext (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:535:6)
          at crossOriginOpenerPolicyMiddleware (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:163:3)
          at internalNext (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:535:6)
          at contentSecurityPolicyMiddleware (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:128:4)
          at internalNext (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:535:6)
          at helmetMiddleware (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\helmet\index.cjs:539:6)
          at Layer.handle [as handle_request] (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\layer.js:95:5)
          at trim_prefix (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:328:13)
          at C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:286:9
          at router.process_params (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:346:12)
          at next (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:280:10)
          at expressInit (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\middleware\init.js:40:5)
          at Layer.handle [as handle_request] (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\layer.js:95:5)
          at trim_prefix (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:328:13)
          at C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:286:9
          at router.process_params (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:346:12)
          at next (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:280:10)
          at query (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\middleware\query.js:45:5)
          at Layer.handle [as handle_request] (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\layer.js:95:5)
          at trim_prefix (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:328:13)
          at C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:286:9
          at router.process_params (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:346:12)
          at next (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:280:10)
          at router.handle (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\router\index.js:175:3)
          at app.handle (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\application.js:181:10)
          at Server.app (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\node_modules\express\lib\express.js:39:9)
          at Server.emit (node:events:508:28)
          at parserOnIncoming (node:_http_server:1186:12)
          at HTTPParser.parserOnHeadersComplete (node:_http_common:123:17)

      26 |         });
      27 |     } catch (error) {
    > 28 |         console.error('List parties error:', error);
         |                 ^
      29 |         res.status(500).json({ error: error.message });
      30 |     }
      31 | });

      at error (src/routes/parties.js:28:17)

    console.error
      [Historian] Failed to log shipment event created: TypeError: Cannot read properties of undefined (reading 'create')
          at Object.create [as logShipmentEvent] (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\src\services\history\historian.js:17:35)
          at logShipmentEvent (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\src\routes\shipments.js:129:25)
          at processTicksAndRejections (node:internal/process/task_queues:103:5)

      24 |             });
      25 |         } catch (error) {
    > 26 |             console.error(`[Historian] Failed to log shipment event ${action}:`, error);
         |                     ^
      27 |         }
      28 |     },
      29 |

      at Object.error [as logShipmentEvent] (src/services/history/historian.js:26:21)
      at logShipmentEvent (src/routes/shipments.js:129:25)

    console.error
      [Historian] Failed to log shipment event updated: TypeError: Cannot read properties of undefined (reading 'create')
          at Object.create [as logShipmentEvent] (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\src\services\history\historian.js:17:35)
          at logShipmentEvent (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\src\routes\shipments.js:200:25)
          at processTicksAndRejections (node:internal/process/task_queues:103:5)

      24 |             });
      25 |         } catch (error) {
    > 26 |             console.error(`[Historian] Failed to log shipment event ${action}:`, error);
         |                     ^
      27 |         }
      28 |     },
      29 |

      at Object.error [as logShipmentEvent] (src/services/history/historian.js:26:21)
      at logShipmentEvent (src/routes/shipments.js:200:25)

    console.error
      [Historian] Failed to log shipment event updated: TypeError: Cannot read properties of undefined (reading 'create')
          at Object.create [as logShipmentEvent] (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\src\services\history\historian.js:17:35)
          at logShipmentEvent (C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api\src\routes\shipments.js:200:25)
          at processTicksAndRejections (node:internal/process/task_queues:103:5)

      24 |             });
      25 |         } catch (error) {
    > 26 |             console.error(`[Historian] Failed to log shipment event ${action}:`, error);
         |                     ^
      27 |         }
      28 |     },
      29 |

      at Object.error [as logShipmentEvent] (src/services/history/historian.js:26:21)
      at logShipmentEvent (src/routes/shipments.js:200:25)

  ΓùÅ Address Book & Shipment Snapshots ΓÇ║ Party CRUD ΓÇ║ GET /parties should list parties

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      126 |                 .set('Authorization', `Bearer ${token}`);
      127 |
    > 128 |             expect(res.statusCode).toBe(200);
          |                                    ^
      129 |             expect(res.body.data).toHaveLength(1);
      130 |             expect(mockPrisma.party.findMany).toHaveBeenCalled();
      131 |         });

      at Object.toBe (tests/parties_shipments.test.js:128:36)

PASS tests/integration.test.js (6.395 s)
  ΓùÅ Console

    console.log
      Updated document mock-doc-id

      at log (src/routes/documents.js:120:17)

    console.log
      Generating PDF for document mock-doc-id as sli using template sli

      at log (src/routes/documents.js:142:17)

PASS tests/sanity.test.js (6.44 s)
PASS tests/features.test.js (6.502 s)
PASS tests/csv_import.test.js (6.574 s)

Test Suites: 3 failed, 13 passed, 16 total
Tests:       2 failed, 48 passed, 50 total
Snapshots:   0 total
Time:        7.378 s, estimated 9 s
Ran all test suites.
npm error Lifecycle script `test` failed with error:
npm error code 1
npm error path C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api
npm error workspace @formwaypoint/api@0.1.0
npm error location C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api
npm error command failed
npm error command C:\Windows\system32\cmd.exe /d /s /c jest
