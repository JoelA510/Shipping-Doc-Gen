
> test
> npm run test --workspaces apps/api/tests/tenancy.test.js


> @formwaypoint/api@0.1.0 test
> jest apps/api/tests/tenancy.test.js

FAIL tests/tenancy.test.js
  Multi-tenant Isolation
    Parties (Address Book)
      â”œÃ¹ GET /parties should filter by createdByUserId (71 ms)
    Items
      â”œÃ¹ GET /items should filter by createdByUserId (7 ms)
    Carriers (Rate Shopping)
      â”œÃ¹ POST /shipments/:id/rates should only use User A carrier accounts (5 ms)

  Î“Ã¹Ã… Multi-tenant Isolation Î“Ã‡â•‘ Parties (Address Book) Î“Ã‡â•‘ GET /parties should filter by createdByUserId

    TypeError: Cannot read properties of undefined (reading '0')

      107 |             // Expectation: The Prisma query MUST include { createdByUserId: userA }
      108 |             // Currently (BUG), it does NOT. So this expectation is what we fail on.
    > 109 |             const callArgs = prisma.party.findMany.mock.calls[0][0];
          |                                                                 ^
      110 |             expect(callArgs.where).toHaveProperty('createdByUserId', userA);
      111 |         });
      112 |     });

      at Object.<anonymous> (tests/tenancy.test.js:109:65)

  Î“Ã¹Ã… Multi-tenant Isolation Î“Ã‡â•‘ Items Î“Ã‡â•‘ GET /items should filter by createdByUserId

    TypeError: Cannot read properties of undefined (reading '0')

      122 |                 .expect(200);
      123 |
    > 124 |             const callArgs = prisma.item.findMany.mock.calls[0][0];
          |                                                                ^
      125 |             expect(callArgs.where).toHaveProperty('createdByUserId', userA);
      126 |         });
      127 |     });

      at Object.<anonymous> (tests/tenancy.test.js:124:64)

  Î“Ã¹Ã… Multi-tenant Isolation Î“Ã‡â•‘ Carriers (Rate Shopping) Î“Ã‡â•‘ POST /shipments/:id/rates should only use User A carrier accounts

    expected 200 "OK", got 404 "Not Found"

      150 |                 .post(`/shipments/${shipmentId}/rates`)
      151 |                 .set('Authorization', `Bearer ${tokenA}`)
    > 152 |                 .expect(200); // Or 400 if no accounts found, but we mock finding them
          |                  ^
      153 |
      154 |             // Expectation: findMany was called with where: { userId: userA }
      155 |             const callArgs = prisma.carrierAccount.findMany.mock.calls[0][0];

      at Object.expect (tests/tenancy.test.js:152:18)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

Test Suites: 1 failed, 1 total
Tests:       3 failed, 3 total
Snapshots:   0 total
Time:        2.42 s
Ran all test suites matching /apps\\api\\tests\\tenancy.test.js/i.
npm error Lifecycle script `test` failed with error:
npm error code 1
npm error path C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api
npm error workspace @formwaypoint/api@0.1.0
npm error location C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\api
npm error command failed
npm error command C:\Windows\system32\cmd.exe /d /s /c jest apps/api/tests/tenancy.test.js


> web@0.1.0 test
> vitest apps/api/tests/tenancy.test.js


[1m[44m DEV [49m[22m [34mv4.0.10 [39m[90mC:/Users/joel.abraham/Shipping Doc Gen/Shipping-Doc-Gen/apps/web[39m

[31mNo test files found. You can change the file name pattern by pressing "p"
[39m
filter: apps/api/tests/tenancy.test.js
include: **/*.{test,spec}.?(c|m)[jt]s?(x)
exclude:  **/node_modules/**, **/dist/**, **/e2e/**, **/tests-e2e/**

(node:27044) [MODULE_TYPELESS_PACKAGE_JSON] Warning: Module type of file:///C:/Users/joel.abraham/Shipping%20Doc%20Gen/Shipping-Doc-Gen/apps/web/postcss.config.js?t=1765404557233 is not specified and it doesn't parse as CommonJS.
Reparsing as ES module because module syntax was detected. This incurs a performance overhead.
To eliminate this warning, add "type": "module" to C:\Users\joel.abraham\Shipping Doc Gen\Shipping-Doc-Gen\apps\web\package.json.
(Use `node --trace-warnings ...` to show where the warning was created)
